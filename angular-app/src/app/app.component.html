<div class="container">
  <h1>AstroKiddo: CIS Final Project</h1>
  <div class="sub">Generate a slideshow from NASA media and view.</div>

  <div class="panel">
    <div class="row">
      @if (form) {
        <form [formGroup]="form">
          <input placeholder="Topic" type="text" formControlName="topic">
          <input placeholder="Grade (e.g., 6-8)" type="text" formControlName="gradeLevel">
          <select type="text" formControlName="locale">
            <option value="en">English</option>
          </select>
        </form>
      }
      <button (click)="generate()" [disabled]="loading">{{ loading ? 'Generating...' : 'Generate' }}</button>
    </div>
    @if (error) {
      <div class="warn">{{ error }}</div>
    }
  </div>

  @if (apod) {
    <div class="panel apod">
      <div class="apod-title">
        <h2>{{ apod.title || 'Astronomy Picture of the Day' }}</h2>
        @if (apod.date) {
          <div class="apod-date">{{ apod.date | date: 'longDate' }}</div>
        }
      </div>
      @if (apod.media_type === 'image' && apod.url) {
        <img class="apod-image" [src]="apod.url" [alt]="apod.title || 'Astronomy Picture of the Day'">
      }
      @else if (apod.thumbnail_url) {
        <img class="apod-image" [src]="apod.thumbnail_url" [alt]="apod.title || 'Astronomy Picture of the Day'">
      }
      <p>{{ apod.explanation }}</p>
      <div class="apod-footer">
        @if (apod.media_type && apod.url && apod.media_type !== 'image') {
          <a class="apod-link" [href]="apod.url" target="_blank" rel="noopener">View media</a>
        }
        @if (apod.copyright) {
          <span>© {{ apod.copyright }}</span>
        }
      </div>
    </div>
  }

  @if (!apod && apodError) {
    <div class="panel">
      <div class="warn">{{ apodError }}</div>
    </div>
  }

  @if (deck) {
    <div class="deck">
      <div class="panel deck-meta">
        <div class="meta-block">
          <h2 class="meta-title">{{ deck.topic }}</h2>
          <div class="meta-line">Deck ID: {{ deck.id }}</div>
          <div class="meta-line">Created: {{ deck.createdAt | date: 'medium' }}</div>
          @if (deck.enrichment?.meta?.model) {
            <div class="meta-line">Model: {{ deck.enrichment.meta.model }}</div>
          }
        </div>
        <div class="meta-actions">
          <button type="button" class="btn" (click)="openSlideshow()">▶ Play Slideshow</button>
        </div>
      </div>
      @if (deck.enrichment; as enrich) {
        @if (hasEnrichment(enrich)) {
          <div class="panel enrichment">
            <h2>Enrichment Highlights</h2>
            <div class="enrichment-grid">
              @if (enrich.hook) {
                <section class="enrichment-section">
                  <h3>Hook</h3>
                  <p>{{ enrich.hook }}</p>
                </section>
              }
              @if (enrich.simple_explanation) {
                <section class="enrichment-section">
                  <h3>Simple Explanation</h3>
                  <p>{{ enrich.simple_explanation }}</p>
                </section>
              }
              @if (enrich.why_it_matters) {
                <section class="enrichment-section">
                  <h3>Why It Matters</h3>
                  <p>{{ enrich.why_it_matters }}</p>
                </section>
              }
              @if (enrich.class_question) {
                <section class="enrichment-section">
                  <h3>Class Question</h3>
                  <p>{{ enrich.class_question }}</p>
                </section>
              }
              @if (enrich.fun_fact) {
                <section class="enrichment-section">
                  <h3>Fun Fact</h3>
                  <p>{{ enrich.fun_fact }}</p>
                </section>
              }
            </div>
            @if (enrich.vocabulary?.length) {
              <div class="enrichment-vocabulary">
                <h3>Vocabulary</h3>
                <ul class="vocab-list">
                  @for (item of enrich.vocabulary; track item) {
                    <li class="vocab-item">
                      <div class="vocab-term">{{ item.term }}</div>
                      <div class="vocab-definition">{{ item.definition }}</div>
                    </li>
                  }
                </ul>
              </div>
            }
            @if (enrich.attribution) {
              <div class="enrichment-footer">
                Attribution: {{ enrich.attribution }}
              </div>
            }
          </div>
        }
      }
      <div class="cards">
        @for (s of deck.slides; track s) {
          <div class="card">
            <div class="badge">{{ s.type }}</div>
            <h3>{{ s.title }}</h3>
            @if (s.imageUrl) {
              <img [src]="s.imageUrl" alt="">
            }
            <p>{{ s.text }}</p>
            @if (s.attribution) {
              <div class="badge">© {{ s.attribution }}</div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

@if (deck && showSlideshow) {
  <div class="slideshow-overlay" role="dialog" aria-modal="true">
    <div class="slideshow-backdrop" (click)="closeSlideshow()"></div>
    <div class="slideshow-stage">
      <button type="button" class="slideshow-close" (click)="closeSlideshow()" aria-label="Close slideshow">✕</button>
      <div class="slideshow-wrapper">
        <div class="reveal" #revealRoot>
          <div class="slides">
            <section>
              <h2>{{ deck.topic }}</h2>
              @if (lastRequest?.gradeLevel) {
                <div class="cover-meta">Grade Level: {{ lastRequest.gradeLevel }}</div>
              }
              <div class="cover-meta">Deck ID: {{ deck.id }}</div>
              <div class="cover-meta">Generated: {{ deck.createdAt | date: 'medium' }}</div>
              @if (deck.enrichment?.meta?.model) {
                <div class="enrichment-chip">Model · {{ deck.enrichment.meta.model }}</div>
              }
              @if (deck.enrichment?.hook) {
                <div class="cover-sub">{{ deck.enrichment.hook }}</div>
              }
            </section>

            @for (slide of deck.slides; track slide) {
              <section>
                @if (slide.title) {
                  <h3>{{ slide.title }}</h3>
                }
                @if (slide.imageUrl) {
                  <img [src]="slide.imageUrl" [alt]="slide.title || 'Slide image'">
                }
                @if (slide.text) {
                  <div class="slide-note">{{ slide.text }}</div>
                }
                <div class="slide-footer">{{ slide.type }}</div>
                @if (slide.attribution) {
                  <div class="slide-attribution">© {{ slide.attribution }}</div>
                }
              </section>
            }

            @if (deck.enrichment?.simple_explanation) {
              <section>
                <h3>Simple Explanation</h3>
                <div class="slide-note">{{ deck.enrichment.simple_explanation }}</div>
              </section>
            }

            @if (deck.enrichment?.why_it_matters) {
              <section>
                <h3>Why It Matters</h3>
                <div class="slide-note">{{ deck.enrichment.why_it_matters }}</div>
              </section>
            }

            @if (deck.enrichment?.class_question) {
              <section>
                <h3>Class Discussion</h3>
                <div class="slide-note">{{ deck.enrichment.class_question }}</div>
              </section>
            }

            @if (deck.enrichment?.fun_fact) {
              <section>
                <h3>Fun Fact</h3>
                <div class="slide-note">{{ deck.enrichment.fun_fact }}</div>
              </section>
            }

            @if (deck.enrichment?.vocabulary?.length) {
              <section>
                <h3 class="vocab-title">Vocabulary Spotlight</h3>
                <ul>
                  @for (term of deck.enrichment.vocabulary; track term) {
                    <li>
                      <div class="term">{{ term.term }}</div>
                      <div class="definition">{{ term.definition }}</div>
                    </li>
                  }
                </ul>
              </section>
            }

            @if (deck.enrichment?.attribution) {
              <section>
                <h3>Enrichment Attribution</h3>
                <div class="slide-note">{{ deck.enrichment.attribution }}</div>
              </section>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}
